# ===========================================
# ISU Backend - Production Docker Compose
# ===========================================
# This file contains all microservices for the ISeeYou Fortune Telling Platform
#
# Usage:
#   1. Ensure env/prod/*.env files are configured
#   2. Create the external network: docker network create isu-internal-network
#   3. Run: docker-compose up -d
#
# Services:
#   - Gateway Service (port 8080)
#   - Core Service (port 8081, Socket.IO: 8082)
#   - Push Notification Service (port 8085)
#   - Report Service (port 8086)
#   - AI Support Service (port 8001)
#   - AI Analysis Service (port 8000)
# ===========================================

name: isu-backend-production

services:
  # ===========================================
  # INFRASTRUCTURE SERVICES
  # ===========================================

  # RabbitMQ - Message Broker
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: isu-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    env_file:
      - ../../env/prod/common.env
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ===========================================
  # CORE SERVICE & DEPENDENCIES
  # ===========================================

  # PostgreSQL - Core Service Database
  postgres-core:
    image: postgres:13.11-bullseye
    container_name: isu-postgres-core
    restart: always
    environment:
      POSTGRES_DB: ${CORE_POSTGRESQL_DB:-fortunetelling}
      POSTGRES_USER: ${CORE_POSTGRESQL_USER:-postgres}
      POSTGRES_PASSWORD: ${CORE_POSTGRESQL_PASSWORD:-secret}
    ports:
      - "${CORE_POSTGRESQL_PORT:-5432}:5432"
    volumes:
      - postgres_core_data:/var/lib/postgresql/data
      - ../../var/logs/postgresql-core:/var/log/postgresql
    networks:
      - isu-internal-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Core Service Cache
  redis:
    image: redis:7.0.12-alpine
    container_name: isu-redis
    restart: always
    command: redis-server --save 20 1 --loglevel warning --requirepass secret
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - isu-internal-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "secret", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Core Backend Service
  core-backend-service:
    build:
      context: ../../ISU-Backend-CoreService
      dockerfile: docker/Dockerfile
    container_name: isu-core-backend
    ports:
      - "${CORE_SERVER_PORT:-8081}:8081"
      - "${SOCKET_IO_PORT:-8082}:8082"
    depends_on:
      postgres-core:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ../../env/prod/core-service.env
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # GATEWAY SERVICE
  # ===========================================

  gateway-service:
    build:
      context: ../../ISU-Backend-GatewayService
      dockerfile: Dockerfile
    container_name: isu-gateway
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    depends_on:
      - core-backend-service
    env_file:
      - ../../env/prod/gateway-service.env
    networks:
      - isu-internal-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================
  # PUSH NOTIFICATION SERVICE & DEPENDENCIES
  # ===========================================

  # MongoDB - Push Notification Database
  mongodb-pushnoti:
    image: mongo:7.0
    container_name: isu-mongodb-pushnoti
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${PUSHNOTI_MONGODB_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${PUSHNOTI_MONGODB_PASSWORD:-secret}
      MONGO_INITDB_DATABASE: ${PUSHNOTI_MONGODB_DB:-pushnoti}
    ports:
      - "${PUSHNOTI_MONGODB_PORT:-27018}:27017"
    volumes:
      - mongodb_pushnoti_data:/data/db
      - ../../var/logs/mongodb-pushnoti:/var/log/mongodb
    networks:
      - isu-internal-network
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "-u",
          "admin",
          "-p",
          "secret",
          "--authenticationDatabase",
          "admin",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Push Notification Service
  pushnoti-service:
    build:
      context: ../../ISU-Backend-PushNoti
      dockerfile: docker/Dockerfile
    container_name: isu-pushnoti
    ports:
      - "${PUSHNOTI_PORT:-8085}:8085"
    depends_on:
      mongodb-pushnoti:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ../../env/prod/pushnoti-service.env
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================
  # REPORT SERVICE & DEPENDENCIES
  # ===========================================

  # MongoDB - Report Service Database
  mongodb-report:
    image: mongo:7.0
    container_name: isu-mongodb-report
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${REPORT_MONGODB_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${REPORT_MONGODB_PASSWORD:-secret}
      MONGO_INITDB_DATABASE: ${REPORT_MONGODB_DB:-report}
    ports:
      - "${REPORT_MONGODB_PORT:-27019}:27017"
    volumes:
      - mongodb_report_data:/data/db
      - ../../var/logs/mongodb-report:/var/log/mongodb
      - ../../ISU-Backend-ReportService/data:/data
    networks:
      - isu-internal-network
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "-u",
          "admin",
          "-p",
          "secret",
          "--authenticationDatabase",
          "admin",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Report Service
  report-service:
    build:
      context: ../../ISU-Backend-ReportService
      dockerfile: docker/Dockerfile
    container_name: isu-report
    ports:
      - "${REPORT_PORT:-8086}:8086"
    depends_on:
      mongodb-report:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ../../env/prod/report-service.env
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================
  # AI SUPPORT SERVICE & DEPENDENCIES
  # ===========================================

  # Neo4j - Graph Database for LightRAG
  neo4j:
    image: neo4j:5.15
    container_name: isu-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/lightrag123
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_whitelist=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "cypher-shell", "-u", "neo4j", "-p", "lightrag123", "RETURN 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # MongoDB - AI Support Database
  mongodb-ai:
    image: mongo:7.0
    container_name: isu-mongodb-ai
    ports:
      - "${AI_MONGODB_PORT:-27022}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=secret
    volumes:
      - mongodb_ai_data:/data/db
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "-u",
          "admin",
          "-p",
          "secret",
          "--authenticationDatabase",
          "admin",
          "--eval",
          "db.adminCommand('ping')",
        ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # AI Support Service (LightRAG)
  lightrag-api:
    build:
      context: ../../ISU-AI-Support
      dockerfile: docker/Dockerfile
    container_name: isu-lightrag-api
    ports:
      - "${AI_SUPPORT_PORT:-8001}:8001"
    env_file:
      - ../../env/prod/ai-support.env
    volumes:
      - ../../ISU-AI-Support/data:/app/data
      - lightrag_storage:/app/rag_storage
      - ../../var/logs/lightrag:/app/logs
    depends_on:
      neo4j:
        condition: service_healthy
      mongodb-ai:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - isu-internal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # AI ANALYSIS SERVICE & DEPENDENCIES
  # ===========================================

  # PostgreSQL - Vanna Database
  postgres-vanna:
    build:
      context: ../../ISU-AI-Analysis
      dockerfile: Dockerfile.postgres
    container_name: isu-postgres-vanna
    restart: always
    environment:
      POSTGRES_DB: ${VANNA_POSTGRES_DB:-vanna}
      POSTGRES_USER: ${VANNA_POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${VANNA_POSTGRES_PASSWORD:-secret}
      TZ: ${TZ:-Asia/Ho_Chi_Minh}
      PGTZ: ${PGTZ:-Asia/Ho_Chi_Minh}
    ports:
      - "${VANNA_POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres_vanna_data:/var/lib/postgresql/data
    networks:
      - isu-internal-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AI Analysis Service (Vanna)
  vanna-server:
    build:
      context: ../../ISU-AI-Analysis
      dockerfile: Dockerfile
    container_name: isu-vanna-server
    restart: always
    ports:
      - "${VANNA_PORT:-8000}:8000"
    env_file:
      - ../../env/prod/ai-analysis.env
    depends_on:
      postgres-vanna:
        condition: service_healthy
    networks:
      - isu-internal-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ===========================================
# VOLUMES
# ===========================================
volumes:
  # RabbitMQ
  rabbitmq_data:

  # Core Service
  postgres_core_data:
  redis_data:

  # Push Notification Service
  mongodb_pushnoti_data:

  # Report Service
  mongodb_report_data:

  # AI Support Service
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  mongodb_ai_data:
  lightrag_storage:

  # AI Analysis Service
  postgres_vanna_data:

# ===========================================
# NETWORKS
# ===========================================
networks:
  isu-internal-network:
    driver: bridge
